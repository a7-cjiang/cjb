<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>订单详情</title>
    <script src="/js/qrcode.min.js"></script>
    <script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
    <!-- 引入bootstrap -->
    <link href="./js/bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="./js/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
    <!--引入bootbox-->
    <script type="text/javascript" src="./js/bootbox/bootbox.all.min.js"></script>
</head>
<body>
<div class="site-nav-bg">
    <div class="site-nav w1200">

            <a href="index.html">首页</a>
        <div>
            <div class="sp-cart"><a href="shopcart.html">购物车</a><span></span><span></span><span></span><span></span><span></span></div>
        </div>
    </div>
</div>
<center>
    <h1>订单详情</h1>
<table id="orderVal" cellpadding="10px">
    <tr>
        <td>订单id</td>
        <td>收货地址</td>
        <td>付款方式</td>
        <td>商品个数</td>
        <td>总金额</td>
        <td>支付状态</td>
    </tr>

</table>


</center>
</body>
<script>
    // 进行ajax的全局设置
    $.ajaxSetup({
        //data:{"name":sessionStorage.getItem("token")}
        headers: {
            'token': sessionStorage.getItem("login_token")
        },
        //数据加载完成后
        complete:function(a,b,c){
            var data=a.responseJSON;
            if(data.code==1000){
                alert(data.message);
                location.href="login.html"
            }
            //debugger
        }
        /* beforeSend: function(xhr) {
             debugger;
             xhr.setRequestHeader("token:'"+sessionStorage.getItem("login_token")+"'");
         }*/
    });




    $(function () {
        initOrderPay()
    })


    function initOrderPay() {

        var addressDeta = ""

        $.get({
            url:"http://192.168.1.160:8088/address/getAddress",
            dataType:"json",
            // async:false,
            success:function (data) {
                if (data.code == 200){
                    for (var i = 0; i < data.data.length; i++) {
                        addressDeta = data.data[i]
                    }
                }
            },error:function () {
                alert("请求收货地址失败")
            }
        })








        $.get({
        url:"http://192.168.1.160:8088/order/queryOrderPay",
        dataType:"json",
        success:function (data) {
            if (data.code == 200){

                var htmls = ""
                htmls = " <tr>\n" +
                    "        <th width='10%'>订单id</th>\n" +
                    "        <th width='20%'>收货地址</th>\n" +
                    "        <th width='10%'>付款方式</th>\n" +
                    "        <th width='10%'>商品数量</th>\n" +
                    "        <th width='10%'>总金额</th>\n" +
                    "        <th width='10%'>支付状态</th>\n" +
                    "        <th width='10%'>订单创建时间</th>\n" +
                    "        <th width='10%'></th>\n" +
                    "    </tr>"


                for (var i = 0; i < data.data.length; i++) {

                    var order = data.data[i]


                    var creatDate = new Date(order.createDate);
                    Y = creatDate.getFullYear() + '-';
                    M = (creatDate.getMonth()+1 < 10 ? '0'+(creatDate.getMonth()+1) : creatDate.getMonth()+1) + '-';
                    D = creatDate.getDate() + ' ';
                    h = creatDate.getHours() + ':';
                    m = creatDate.getMinutes() + ':';
                    s = creatDate.getSeconds();


                    if(order.payType == 1){
                      payType=  '        <th>微信支付</th>\n'
                    }else {
                        payType=  '        <th>支付宝支付</th>\n'
                    }

                    if(order.payStatus == 0){
                        payStatus =  '        <th>未支付</th>\n'
                    }else if (order.payStatus == 2){
                        payStatus =  '        <th>已支付</th>\n'
                    }else {
                        payStatus =  '        <th>待支付</th>\n'
                    }

                    var caozuo_ssn = ""

                    if (order.payStatus == 2){
                        caozuo_ssn = '        <th><input type="button" value="订单详情" onclick="selectOrder('+order.id+')"></th>\n'
                    } else {
                        caozuo_ssn = '        <th><input type="button" value="现在支付" onclick="goToPay('+order.id+','+order.totalMoney+')"></th>\n'
                    }

                    if(order.addressId == 1){
                        addressDeta = '        <th>新芒果南苑2号楼3303  张三  11111111111</th>'
                    }else if (order.addressId == 2){
                        addressDeta = '        <th>升龙又一城  李四  12312312312</th>'
                    }else {
                        addressDeta = '        <th>新芒果南苑2号楼3303  侯超凡  12345678900</th>'
                    }


                    htmls += '<tr>' +

                        ' <th width=\'10%\'>'+order.id+'</th>\n' +
                        addressDeta +
                        payType +
                        '        <th>'+order.productCount+'</th>\n' +
                        '        <th>'+order.totalMoney+'</th>\n' +
                        payStatus +
                        '        <th>'+Y+M+D+h+m+s+'</th>\n' +
                        caozuo_ssn +
                        '</tr>'
                }
                $("#orderVal").html(htmls)
            }
        },error:function () {
            alert("请求订单详细信息异常")
        }
    })

    }

    function goToPay(id,totalmoney) {
        // alert(id)
        // alert(totalmoney)
        sessionStorage.setItem("orderId",id)
        sessionStorage.setItem("money",totalmoney)
        location.href = "pay.html"

    }

    function selectOrder(id) {
        bootbox.alert({
            size: "big",
            title: ""+id+"号订单详情",
            message: "<table id=\"ord\" cellpadding=\"10px\" cellspacing=\"10px\">\n" +

                "</table>",
            callback: function(){

            }
        });

        $.get({
            url:"http://192.168.1.160:8088/order/getOrderDeta",
            dataType:"json",
            data:{"id":id},
            success:function (data) {
                if (data.code == 200){

                    var htmls = ""
                    htmls = " <tr>\n" +
                        "        <th width='10%'>订单id</th>\n" +
                        "        <th width='10%'>商品id</th>\n" +
                        "        <th width='10%'>商品数量</th>\n" +
                        "    </tr>"


                    for (var i = 0; i < data.data.length; i++) {

                        var order = data.data[i]


                        htmls += '<tr>' +

                            ' <th width=\'10%\'>'+order.orderId+'</th>\n' +
                            '        <th>'+order.productId+'</th>\n' +
                            '        <th>'+order.count+'</th>\n' +
                            '</tr>'
                    }
                    $("#ord").html(htmls)
                }
            },error:function () {
                alert("请求订单信息失败")
            }
        })

    }



</script>
</html>
